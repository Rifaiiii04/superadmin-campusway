# Apache Virtual Host Configuration for TKA Application
# This file should be placed in /etc/apache2/sites-available/tka.conf

<VirtualHost *:80>
    ServerName 103.23.198.101
    DocumentRoot /var/www/html
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/tka_error.log
    CustomLog ${APACHE_LOG_DIR}/tka_access.log combined
    
    # Next.js Frontend (Root) - Handle all requests first
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Handle Next.js static files
        <FilesMatch "\.(js|css|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot|ico)$">
            Header always set Cache-Control "public, max-age=31536000"
        </FilesMatch>
    </Directory>
    
    # Laravel Super Admin (Subfolder) - Only handle /super-admin requests
    Alias /super-admin /var/www/superadmin/superadmin-campusway/public
    
    <Directory /var/www/superadmin/superadmin-campusway/public>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Laravel rewrite rules
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^ index.php [L]
        
        # Fix MIME types for static assets
        <FilesMatch "\.(js|css|json)$">
            Header always set Content-Type "application/javascript"
        </FilesMatch>
        
        <FilesMatch "\.css$">
            Header always set Content-Type "text/css"
        </FilesMatch>
        
        <FilesMatch "\.json$">
            Header always set Content-Type "application/json"
        </FilesMatch>
        
        # Cache static assets
        <FilesMatch "\.(js|css|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot)$">
            Header always set Cache-Control "public, max-age=31536000"
        </FilesMatch>
        
        # Security headers
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options DENY
        Header always set X-XSS-Protection "1; mode=block"
        
        # CORS for API access
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-CSRF-TOKEN"
    </Directory>
    
    # Prevent Next.js from handling /super-admin requests
    <LocationMatch "^/super-admin">
        # Ensure this is handled by Laravel, not Next.js
        RewriteEngine On
        RewriteCond %{REQUEST_URI} ^/super-admin
        RewriteRule ^(.*)$ /super-admin/$1 [L]
    </LocationMatch>
    
    # Handle preflight requests
    <LocationMatch "^/super-admin/api">
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-CSRF-TOKEN"
        
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^(.*)$ $1 [R=200,L]
    </LocationMatch>
</VirtualHost>

# Enable required modules
# Run: sudo a2enmod rewrite headers deflate expires
